{
  "heat_template_version": "@import!openstack.json#heat.version",
  "description": "Simple template to deploy a single compute instance",
  "resources": {
    "docker-master": {
      "type": "OS::Nova::Server",
      "properties": {
        "count": 1,
        "key_name": "@import!secrets.json#keypair",
        "image": "d6929048-3a81-4bf7-b5ef-d69bd67219ba",
        "flavor": "m1.small",
        "networks": {
          "port": {
            "get_resource": "docker_master_port"
          },
          "user_data_format": "RAW",
          "user_data": "@import!openstack.json#cluster.master-userdata"
        }
      }
    },
    "docker-worker": {
      "type": "OS::Nova::Server",
      "properties": {
        "count": 2,
        "key_name": "@import!secrets.json#keypair",
        "image": "d6929048-3a81-4bf7-b5ef-d69bd67219ba",
        "flavor": "m1.small"
      }
    },
    "swarm_network": {
      "type": "OS::Neutron::Net",
      "properties": {
        "name": "swarm_network",
        "shared": false
      }
    },
    "swarm_subnet": {
      "type": "OS::Neutron::Subnet",
      "properties": {
        "network": {
          "get_resource": "swarm_network"
        },
        "ip_version": 4,
        "dns_nameservers": [
          "8.8.8.8"
        ],
        "cidr": "10.0.2.0/24",
        "gateway_ip": "10.0.2.1"
      }
    },
    "swarm_router": {
      "type": "OS::Neutron::Router",
      "properties": {
        "external_gateway_info": {
          "network": "@import!openstack.json#cluster.public-network-id"
        }
      }
    },
    "router_interface": {
      "type": "OS::Neutron::RouterInterface",
      "properties": {
        "router_id": {
          "get_resource": "swarm_router"
        },
        "subnet_id": {
          "get_resource": "swarm_subnet"
        }
      }
    },
    "docker_master_port": {
      "type": "OS::Neutron::Port",
      "properties": {
        "network": {
          "get_resource": "swarm_network"
        },
        "fixed_ips": [
          {
            "subnet_id": {
              "get_resource": "swarm_subnet"
            },
            "ip_address": "10.0.2.21"
          }
        ],
        "security_groups": [
          {
            "get_resource": "swarm_securitygroup"
          }
        ]
      }
    },
    "docker_floating_ip": {
      "type": "OS::Neutron::FloatingIP",
      "depends_on": "router_interface",
      "properties": {
        "floating_network_id": "@import!openstack.json#cluster.public-network-id",
        "port_id": {
          "get_resource": "docker_master_port"
        }
      }
    },
    "swarm_securitygroup": {
      "type": "OS::Neutron::SecurityGroup",
      "properties": {
        "name": "swarm-securitygroup",
        "rules": [
          {
            "remote_ip_prefix": "0.0.0.0/0",
            "protocol": "tcp",
            "port_range_min": 22,
            "port_range_max": 22
          },
          {
            "remote_ip_prefix": "0.0.0.0/0",
            "protocol": "tcp",
            "port_range_min": 2377,
            "port_range_max": 2377
          },
          {
            "remote_ip_prefix": "0.0.0.0/0",
            "protocol": "icmp"
          },
          {
            "remote_mode": "remote_group_id",
            "protocol": "tcp",
            "port_range_min": 1,
            "port_range_max": 65535
          },
          {
            "remote_mode": "remote_group_id",
            "protocol": "udp",
            "port_range_min": 1,
            "port_range_max": 65535
          }
        ]
      }
    }
  }
}